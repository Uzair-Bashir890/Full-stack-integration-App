@page "/fetchproducts"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http

<h3>Product List</h3>

@if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}

<div class="products-container">
    @if (apiResponse != null)
    {
        <div class="metadata">
            <small>Last updated: @apiResponse.Timestamp.ToLocalTime()</small>
            <small>Total products: @apiResponse.Count</small>
        </div>

        <div class="product-grid">
            @foreach (var product in apiResponse.Data)
            {
                <div class="product-card">
                    <h4>@product.Name</h4>
                    <div class="category-badge">@product.Category.Name</div>
                    <div class="product-details">
                        <p class="price">$@product.Price.ToString("F2")</p>
                        <p class="stock @(product.Stock < 20 ? "low-stock" : "")">
                            Stock: @product.Stock
                        </p>
                    </div>
                </div>
            }
        </div>
    }
    else if (errorMessage == null)
    {
        <div class="loading">
            <p>Loading products...</p>
        </div>
    }
</div>

<style>
    .products-container {
        padding: 20px;
    }

    .metadata {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        color: #666;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .product-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .category-badge {
        display: inline-block;
        background-color: #e9ecef;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        margin: 8px 0;
    }

    .product-details {
        margin-top: 10px;
    }

    .price {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
    }

    .stock {
        color: #28a745;
    }

    .low-stock {
        color: #dc3545;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

@code {
    private ApiResponse? apiResponse;
    private string? errorMessage;
    private bool isLoading = true;
    private static ApiResponse? cachedResponse;
    private static DateTime? lastFetch;
    private readonly TimeSpan cacheExpiration = TimeSpan.FromMinutes(5);
    private readonly JsonSerializerOptions jsonOptions = new()
    {
        PropertyNameCaseInsensitive = true
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if we have a valid cached response
            if (cachedResponse != null && lastFetch.HasValue && 
                DateTime.UtcNow - lastFetch.Value < cacheExpiration)
            {
                apiResponse = cachedResponse;
                isLoading = false;
                return;
            }

            await LoadProductData();
        }
        catch (Exception ex)
        {
            HandleError(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadProductData()
    {
        try
        {
            // Configure HttpClient (in production, this would be configured in Program.cs)
            Http.BaseAddress ??= new Uri("http://localhost:5000");
            Http.DefaultRequestHeaders.CacheControl = new System.Net.Http.Headers.CacheControlHeaderValue
            {
                MaxAge = cacheExpiration
            };

            // Make the API call with a timeout
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            var response = await Http.GetAsync("/api/productlist", cts.Token);
            response.EnsureSuccessStatusCode();
            
            var json = await response.Content.ReadAsStringAsync();
            apiResponse = JsonSerializer.Deserialize<ApiResponse>(json, jsonOptions);
            
            if (apiResponse?.Data == null || !apiResponse.Data.Any())
            {
                errorMessage = "No products found.";
            }
            else
            {
                // Cache the successful response
                cachedResponse = apiResponse;
                lastFetch = DateTime.UtcNow;
            }
        }
        catch (Exception)
        {
            throw; // Let the caller handle the error
        }
    }

    private void HandleError(Exception ex)
    {
        errorMessage = ex switch
        {
            OperationCanceledException _ => "The request timed out. Please try again.",
            HttpRequestException httpEx => $"Error fetching products: {httpEx.Message}",
            JsonException jsonEx => $"Error parsing product data: {jsonEx.Message}",
            _ => $"An unexpected error occurred: {ex.Message}"
        };

        Console.WriteLine($"Error details: {ex}");
    }

    public class Category
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int Stock { get; set; }
        public Category Category { get; set; } = new();
    }

    public class ApiResponse
    {
        public string Status { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public IEnumerable<Product> Data { get; set; } = Array.Empty<Product>();
        public int Count { get; set; }
    }
}